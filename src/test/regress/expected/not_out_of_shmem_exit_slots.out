-- Used to be a bug where we release the gangs and reset context. The
-- subsequent retry succeeds with the new gang. When resetting the
-- session, as the warning message says, we drop ongoing temporary
-- namespace. However, whenever new temporary namespace is created, we
-- install shmem_exit callback for this namespace clean up. We earlier
-- missed to uninstall this callback on resetting the gang. That was
-- the reason this test exposed out of shmem_exit slots. Currently
-- MAX_ON_EXITS is set to 20 hence creates 20 transactions. Erroring
-- commit_prepared first time is used as vehicle to trigger gang
-- reset.
-- start_matchsubs
-- m/WARNING:.*Any temporary tables for this session have been dropped because the gang was disconnected/
-- s/session id \=\s*\d+/session id \= DUMMY/gm
-- end_matchsubs
CREATE TABLE foo(a int, b int);
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column named 'a' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
-- 1
CREATE TEMP TABLE foo_stg AS SELECT * FROM foo;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column(s) named 'a' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
SET debug_dtm_action_segment=1;
SET debug_dtm_action_target=protocol;
SET debug_dtm_action_protocol=commit_prepared;
SET debug_dtm_action=fail_begin_command;
DROP TABLE foo_stg;
WARNING:  the distributed transaction 'Commit Prepared' broadcast failed to one or more segments for gid = 1552561439-0000000072.  Retrying ... try 1
NOTICE:  Releasing segworker group to retry broadcast.
WARNING:  Any temporary tables for this session have been dropped because the gang was disconnected (session id = 59)
-- 2
RESET debug_dtm_action_segment;
RESET debug_dtm_action_target;
RESET debug_dtm_action_protocol;
RESET debug_dtm_action;
CREATE TEMP TABLE foo_stg AS SELECT * FROM foo;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column(s) named 'a' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
SET debug_dtm_action_segment=1;
SET debug_dtm_action_target=protocol;
SET debug_dtm_action_protocol=commit_prepared;
SET debug_dtm_action=fail_begin_command;
DROP TABLE foo_stg;
WARNING:  the distributed transaction 'Commit Prepared' broadcast failed to one or more segments for gid = 1552561439-0000000082.  Retrying ... try 1
NOTICE:  Releasing segworker group to retry broadcast.
WARNING:  Any temporary tables for this session have been dropped because the gang was disconnected (session id = 60)
-- 3
RESET debug_dtm_action_segment;
RESET debug_dtm_action_target;
RESET debug_dtm_action_protocol;
RESET debug_dtm_action;
CREATE TEMP TABLE foo_stg AS SELECT * FROM foo;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column(s) named 'a' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
SET debug_dtm_action_segment=1;
SET debug_dtm_action_target=protocol;
SET debug_dtm_action_protocol=commit_prepared;
SET debug_dtm_action=fail_begin_command;
DROP TABLE foo_stg;
WARNING:  the distributed transaction 'Commit Prepared' broadcast failed to one or more segments for gid = 1552561439-0000000092.  Retrying ... try 1
NOTICE:  Releasing segworker group to retry broadcast.
WARNING:  Any temporary tables for this session have been dropped because the gang was disconnected (session id = 61)
-- 4
RESET debug_dtm_action_segment;
RESET debug_dtm_action_target;
RESET debug_dtm_action_protocol;
RESET debug_dtm_action;
CREATE TEMP TABLE foo_stg AS SELECT * FROM foo;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column(s) named 'a' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
SET debug_dtm_action_segment=1;
SET debug_dtm_action_target=protocol;
SET debug_dtm_action_protocol=commit_prepared;
SET debug_dtm_action=fail_begin_command;
DROP TABLE foo_stg;
WARNING:  the distributed transaction 'Commit Prepared' broadcast failed to one or more segments for gid = 1552561439-0000000102.  Retrying ... try 1
NOTICE:  Releasing segworker group to retry broadcast.
WARNING:  Any temporary tables for this session have been dropped because the gang was disconnected (session id = 62)
-- 5
RESET debug_dtm_action_segment;
RESET debug_dtm_action_target;
RESET debug_dtm_action_protocol;
RESET debug_dtm_action;
CREATE TEMP TABLE foo_stg AS SELECT * FROM foo;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column(s) named 'a' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
SET debug_dtm_action_segment=1;
SET debug_dtm_action_target=protocol;
SET debug_dtm_action_protocol=commit_prepared;
SET debug_dtm_action=fail_begin_command;
DROP TABLE foo_stg;
WARNING:  the distributed transaction 'Commit Prepared' broadcast failed to one or more segments for gid = 1552561439-0000000112.  Retrying ... try 1
NOTICE:  Releasing segworker group to retry broadcast.
WARNING:  Any temporary tables for this session have been dropped because the gang was disconnected (session id = 63)
-- 6
RESET debug_dtm_action_segment;
RESET debug_dtm_action_target;
RESET debug_dtm_action_protocol;
RESET debug_dtm_action;
CREATE TEMP TABLE foo_stg AS SELECT * FROM foo;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column(s) named 'a' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
SET debug_dtm_action_segment=1;
SET debug_dtm_action_target=protocol;
SET debug_dtm_action_protocol=commit_prepared;
SET debug_dtm_action=fail_begin_command;
DROP TABLE foo_stg;
WARNING:  the distributed transaction 'Commit Prepared' broadcast failed to one or more segments for gid = 1552561439-0000000122.  Retrying ... try 1
NOTICE:  Releasing segworker group to retry broadcast.
WARNING:  Any temporary tables for this session have been dropped because the gang was disconnected (session id = 64)
-- 7
RESET debug_dtm_action_segment;
RESET debug_dtm_action_target;
RESET debug_dtm_action_protocol;
RESET debug_dtm_action;
CREATE TEMP TABLE foo_stg AS SELECT * FROM foo;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column(s) named 'a' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
SET debug_dtm_action_segment=1;
SET debug_dtm_action_target=protocol;
SET debug_dtm_action_protocol=commit_prepared;
SET debug_dtm_action=fail_begin_command;
DROP TABLE foo_stg;
WARNING:  the distributed transaction 'Commit Prepared' broadcast failed to one or more segments for gid = 1552561439-0000000132.  Retrying ... try 1
NOTICE:  Releasing segworker group to retry broadcast.
WARNING:  Any temporary tables for this session have been dropped because the gang was disconnected (session id = 65)
-- 8
RESET debug_dtm_action_segment;
RESET debug_dtm_action_target;
RESET debug_dtm_action_protocol;
RESET debug_dtm_action;
CREATE TEMP TABLE foo_stg AS SELECT * FROM foo;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column(s) named 'a' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
SET debug_dtm_action_segment=1;
SET debug_dtm_action_target=protocol;
SET debug_dtm_action_protocol=commit_prepared;
SET debug_dtm_action=fail_begin_command;
DROP TABLE foo_stg;
WARNING:  the distributed transaction 'Commit Prepared' broadcast failed to one or more segments for gid = 1552561439-0000000142.  Retrying ... try 1
NOTICE:  Releasing segworker group to retry broadcast.
WARNING:  Any temporary tables for this session have been dropped because the gang was disconnected (session id = 66)
-- 9
RESET debug_dtm_action_segment;
RESET debug_dtm_action_target;
RESET debug_dtm_action_protocol;
RESET debug_dtm_action;
CREATE TEMP TABLE foo_stg AS SELECT * FROM foo;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column(s) named 'a' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
SET debug_dtm_action_segment=1;
SET debug_dtm_action_target=protocol;
SET debug_dtm_action_protocol=commit_prepared;
SET debug_dtm_action=fail_begin_command;
DROP TABLE foo_stg;
WARNING:  the distributed transaction 'Commit Prepared' broadcast failed to one or more segments for gid = 1552561439-0000000152.  Retrying ... try 1
NOTICE:  Releasing segworker group to retry broadcast.
WARNING:  Any temporary tables for this session have been dropped because the gang was disconnected (session id = 67)
-- 10
RESET debug_dtm_action_segment;
RESET debug_dtm_action_target;
RESET debug_dtm_action_protocol;
RESET debug_dtm_action;
CREATE TEMP TABLE foo_stg AS SELECT * FROM foo;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column(s) named 'a' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
SET debug_dtm_action_segment=1;
SET debug_dtm_action_target=protocol;
SET debug_dtm_action_protocol=commit_prepared;
SET debug_dtm_action=fail_begin_command;
DROP TABLE foo_stg;
WARNING:  the distributed transaction 'Commit Prepared' broadcast failed to one or more segments for gid = 1552561439-0000000162.  Retrying ... try 1
NOTICE:  Releasing segworker group to retry broadcast.
WARNING:  Any temporary tables for this session have been dropped because the gang was disconnected (session id = 68)
-- 11
RESET debug_dtm_action_segment;
RESET debug_dtm_action_target;
RESET debug_dtm_action_protocol;
RESET debug_dtm_action;
CREATE TEMP TABLE foo_stg AS SELECT * FROM foo;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column(s) named 'a' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
SET debug_dtm_action_segment=1;
SET debug_dtm_action_target=protocol;
SET debug_dtm_action_protocol=commit_prepared;
SET debug_dtm_action=fail_begin_command;
DROP TABLE foo_stg;
WARNING:  the distributed transaction 'Commit Prepared' broadcast failed to one or more segments for gid = 1552561439-0000000172.  Retrying ... try 1
NOTICE:  Releasing segworker group to retry broadcast.
WARNING:  Any temporary tables for this session have been dropped because the gang was disconnected (session id = 69)
-- 12
RESET debug_dtm_action_segment;
RESET debug_dtm_action_target;
RESET debug_dtm_action_protocol;
RESET debug_dtm_action;
CREATE TEMP TABLE foo_stg AS SELECT * FROM foo;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column(s) named 'a' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
SET debug_dtm_action_segment=1;
SET debug_dtm_action_target=protocol;
SET debug_dtm_action_protocol=commit_prepared;
SET debug_dtm_action=fail_begin_command;
DROP TABLE foo_stg;
WARNING:  the distributed transaction 'Commit Prepared' broadcast failed to one or more segments for gid = 1552561439-0000000182.  Retrying ... try 1
NOTICE:  Releasing segworker group to retry broadcast.
WARNING:  Any temporary tables for this session have been dropped because the gang was disconnected (session id = 70)
-- 13
RESET debug_dtm_action_segment;
RESET debug_dtm_action_target;
RESET debug_dtm_action_protocol;
RESET debug_dtm_action;
CREATE TEMP TABLE foo_stg AS SELECT * FROM foo;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column(s) named 'a' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
SET debug_dtm_action_segment=1;
SET debug_dtm_action_target=protocol;
SET debug_dtm_action_protocol=commit_prepared;
SET debug_dtm_action=fail_begin_command;
DROP TABLE foo_stg;
WARNING:  the distributed transaction 'Commit Prepared' broadcast failed to one or more segments for gid = 1552561439-0000000192.  Retrying ... try 1
NOTICE:  Releasing segworker group to retry broadcast.
WARNING:  Any temporary tables for this session have been dropped because the gang was disconnected (session id = 71)
-- 14
RESET debug_dtm_action_segment;
RESET debug_dtm_action_target;
RESET debug_dtm_action_protocol;
RESET debug_dtm_action;
CREATE TEMP TABLE foo_stg AS SELECT * FROM foo;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column(s) named 'a' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
SET debug_dtm_action_segment=1;
SET debug_dtm_action_target=protocol;
SET debug_dtm_action_protocol=commit_prepared;
SET debug_dtm_action=fail_begin_command;
DROP TABLE foo_stg;
WARNING:  the distributed transaction 'Commit Prepared' broadcast failed to one or more segments for gid = 1552561439-0000000202.  Retrying ... try 1
NOTICE:  Releasing segworker group to retry broadcast.
WARNING:  Any temporary tables for this session have been dropped because the gang was disconnected (session id = 72)
-- 15
RESET debug_dtm_action_segment;
RESET debug_dtm_action_target;
RESET debug_dtm_action_protocol;
RESET debug_dtm_action;
CREATE TEMP TABLE foo_stg AS SELECT * FROM foo;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column(s) named 'a' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
SET debug_dtm_action_segment=1;
SET debug_dtm_action_target=protocol;
SET debug_dtm_action_protocol=commit_prepared;
SET debug_dtm_action=fail_begin_command;
DROP TABLE foo_stg;
WARNING:  the distributed transaction 'Commit Prepared' broadcast failed to one or more segments for gid = 1552561439-0000000212.  Retrying ... try 1
NOTICE:  Releasing segworker group to retry broadcast.
WARNING:  Any temporary tables for this session have been dropped because the gang was disconnected (session id = 73)
-- 16
RESET debug_dtm_action_segment;
RESET debug_dtm_action_target;
RESET debug_dtm_action_protocol;
RESET debug_dtm_action;
CREATE TEMP TABLE foo_stg AS SELECT * FROM foo;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column(s) named 'a' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
SET debug_dtm_action_segment=1;
SET debug_dtm_action_target=protocol;
SET debug_dtm_action_protocol=commit_prepared;
SET debug_dtm_action=fail_begin_command;
DROP TABLE foo_stg;
WARNING:  the distributed transaction 'Commit Prepared' broadcast failed to one or more segments for gid = 1552561439-0000000222.  Retrying ... try 1
NOTICE:  Releasing segworker group to retry broadcast.
WARNING:  Any temporary tables for this session have been dropped because the gang was disconnected (session id = 74)
-- 17
RESET debug_dtm_action_segment;
RESET debug_dtm_action_target;
RESET debug_dtm_action_protocol;
RESET debug_dtm_action;
CREATE TEMP TABLE foo_stg AS SELECT * FROM foo;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column(s) named 'a' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
SET debug_dtm_action_segment=1;
SET debug_dtm_action_target=protocol;
SET debug_dtm_action_protocol=commit_prepared;
SET debug_dtm_action=fail_begin_command;
DROP TABLE foo_stg;
WARNING:  the distributed transaction 'Commit Prepared' broadcast failed to one or more segments for gid = 1552561439-0000000232.  Retrying ... try 1
NOTICE:  Releasing segworker group to retry broadcast.
WARNING:  Any temporary tables for this session have been dropped because the gang was disconnected (session id = 75)
-- 18
RESET debug_dtm_action_segment;
RESET debug_dtm_action_target;
RESET debug_dtm_action_protocol;
RESET debug_dtm_action;
CREATE TEMP TABLE foo_stg AS SELECT * FROM foo;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column(s) named 'a' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
SET debug_dtm_action_segment=1;
SET debug_dtm_action_target=protocol;
SET debug_dtm_action_protocol=commit_prepared;
SET debug_dtm_action=fail_begin_command;
DROP TABLE foo_stg;
WARNING:  the distributed transaction 'Commit Prepared' broadcast failed to one or more segments for gid = 1552561439-0000000242.  Retrying ... try 1
NOTICE:  Releasing segworker group to retry broadcast.
WARNING:  Any temporary tables for this session have been dropped because the gang was disconnected (session id = 76)
-- 19
RESET debug_dtm_action_segment;
RESET debug_dtm_action_target;
RESET debug_dtm_action_protocol;
RESET debug_dtm_action;
CREATE TEMP TABLE foo_stg AS SELECT * FROM foo;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column(s) named 'a' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
SET debug_dtm_action_segment=1;
SET debug_dtm_action_target=protocol;
SET debug_dtm_action_protocol=commit_prepared;
SET debug_dtm_action=fail_begin_command;
DROP TABLE foo_stg;
WARNING:  the distributed transaction 'Commit Prepared' broadcast failed to one or more segments for gid = 1552561439-0000000252.  Retrying ... try 1
NOTICE:  Releasing segworker group to retry broadcast.
WARNING:  Any temporary tables for this session have been dropped because the gang was disconnected (session id = 77)
-- 20
RESET debug_dtm_action_segment;
RESET debug_dtm_action_target;
RESET debug_dtm_action_protocol;
RESET debug_dtm_action;
CREATE TEMP TABLE foo_stg AS SELECT * FROM foo;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column(s) named 'a' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
SET debug_dtm_action_segment=1;
SET debug_dtm_action_target=protocol;
SET debug_dtm_action_protocol=commit_prepared;
SET debug_dtm_action=fail_begin_command;
DROP TABLE foo_stg;
WARNING:  the distributed transaction 'Commit Prepared' broadcast failed to one or more segments for gid = 1552561439-0000000262.  Retrying ... try 1
NOTICE:  Releasing segworker group to retry broadcast.
WARNING:  Any temporary tables for this session have been dropped because the gang was disconnected (session id = 78)
